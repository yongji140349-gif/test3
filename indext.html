import React, { useState, useEffect, useRef } from 'react';
import { Send, Bot, User, Code, Copy, Check, Terminal, Cpu, RefreshCw, Zap } from 'lucide-react';

// --- Knowledge Base (‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ) ---
const KNOWLEDGE_BASE = [
  {
    keywords: ['‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ', 'hi', 'hello', 'tinn'],
    response: "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ Arduino Assistant ü§ñ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏•‡∏∞‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Sensor ‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡∏°‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô '‡∏Ç‡∏≠‡πÇ‡∏Ñ‡πâ‡∏î‡∏ß‡∏±‡∏î‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥' ‡∏´‡∏£‡∏∑‡∏≠ '‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ Servo'",
    code: null
  },
  {
    keywords: ['led', 'blinking', '‡πÑ‡∏ü‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö', '‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏¥‡∏î‡πÑ‡∏ü'],
    topic: 'LED Blink',
    response: "‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡πÇ‡∏Ñ‡πâ‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÑ‡∏ü‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö (Blink) ‡∏ó‡∏µ‡πà‡∏Ç‡∏≤ 13 ‡∏Ñ‡∏£‡∏±‡∏ö",
    code: `void setup() {
  pinMode(13, OUTPUT); // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏≤ 13 ‡πÄ‡∏õ‡πá‡∏ô Output
}

void loop() {
  digitalWrite(13, HIGH); // ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü
  delay(1000);            // ‡∏£‡∏≠ 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  digitalWrite(13, LOW);  // ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü
  delay(1000);            // ‡∏£‡∏≠ 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
}`
  },
  {
    keywords: ['ultrasonic', 'hcsr04', 'hc-sr04', '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á', 'distance', '‡∏ß‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞'],
    topic: 'Ultrasonic (HC-SR04)',
    response: "‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ HC-SR04 ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î:",
    code: `const int trigPin = 9;
const int echoPin = 10;

void setup() {
  Serial.begin(9600);
  pinMode(trigPin, OUTPUT);
  pinMode(echoPin, INPUT);
}

void loop() {
  long duration;
  int distance;

  // ‡∏™‡πà‡∏á‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ
  digitalWrite(trigPin, LOW);
  delayMicroseconds(2);
  digitalWrite(trigPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin, LOW);

  // ‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
  duration = pulseIn(echoPin, HIGH);

  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (cm)
  distance = duration * 0.034 / 2;

  Serial.print("Distance: ");
  Serial.print(distance);
  Serial.println(" cm");
  
  delay(100);
}`
  },
  {
    keywords: ['dht', 'dht11', 'dht22', 'temperature', 'humidity', '‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô'],
    topic: 'DHT11/DHT22',
    response: "‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å DHT11 ‡∏´‡∏£‡∏∑‡∏≠ DHT22 ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ 'DHT.h' ‡∏Ñ‡∏£‡∏±‡∏ö (‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Library ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö)",
    code: `#include "DHT.h"

#define DHTPIN 2     // ‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö DHT
#define DHTTYPE DHT11   // ‡∏´‡∏£‡∏∑‡∏≠ DHT22

DHT dht(DHTPIN, DHTTYPE);

void setup() {
  Serial.begin(9600);
  dht.begin();
}

void loop() {
  delay(2000); // ‡∏£‡∏≠‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤

  float h = dht.readHumidity();
  float t = dht.readTemperature();

  if (isnan(h) || isnan(t)) {
    Serial.println("Failed to read from DHT sensor!");
    return;
  }

  Serial.print("Humidity: ");
  Serial.print(h);
  Serial.print(" %\t");
  Serial.print("Temperature: ");
  Serial.print(t);
  Serial.println(" *C");
}`
  },
  {
    keywords: ['ldr', 'light', 'photoresistor', '‡πÅ‡∏™‡∏á', '‡∏ß‡∏±‡∏î‡πÅ‡∏™‡∏á'],
    topic: 'LDR (Light Sensor)',
    response: "LDR ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡πâ‡∏≤‡∏ô‡∏ó‡∏≤‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡πÅ‡∏™‡∏á ‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÅ‡∏ö‡∏ö Analog ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏¢‡∏¥‡πà‡∏á‡πÅ‡∏™‡∏á‡∏°‡∏≤‡∏Å ‡∏Ñ‡πà‡∏≤‡∏à‡∏∞‡∏¢‡∏¥‡πà‡∏á‡∏ô‡πâ‡∏≠‡∏¢ (‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏ß‡∏á‡∏à‡∏£)",
    code: `const int ldrPin = A0; // ‡∏ï‡πà‡∏≠‡∏Ç‡∏≤ LDR ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö A0

void setup() {
  Serial.begin(9600);
}

void loop() {
  int ldrValue = analogRead(ldrPin); // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ 0-1023
  
  Serial.print("Light Level: ");
  Serial.println(ldrValue);
  
  delay(500);
}`
  },
  {
    keywords: ['servo', 'motor', 'servomotor', '‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÇ‡∏ß', '‡∏´‡∏°‡∏∏‡∏ô'],
    topic: 'Servo Motor',
    response: "‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Servo Motor ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ <Servo.h> ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏á‡∏®‡∏≤ (0-180)",
    code: `#include <Servo.h>

Servo myservo;  

void setup() {
  myservo.attach(9);  // ‡∏ï‡πà‡∏≠‡∏™‡∏≤‡∏¢‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡∏≤ 9
}

void loop() {
  myservo.write(0);   // ‡∏´‡∏°‡∏∏‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà 0 ‡∏≠‡∏á‡∏®‡∏≤
  delay(1000);
  myservo.write(90);  // ‡∏´‡∏°‡∏∏‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà 90 ‡∏≠‡∏á‡∏®‡∏≤
  delay(1000);
  myservo.write(180); // ‡∏´‡∏°‡∏∏‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà 180 ‡∏≠‡∏á‡∏®‡∏≤
  delay(1000);
}`
  },
  {
    keywords: ['relay', 'switch', '‡∏£‡∏µ‡πÄ‡∏•‡∏¢‡πå', '‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå', '‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏ö‡πâ‡∏≤‡∏ô'],
    topic: 'Relay Module',
    response: "Relay ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå‡πÑ‡∏ü‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏î‡∏¥‡∏à‡∏¥‡∏ï‡∏≠‡∏• ‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö Active LOW (LOW = ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô)",
    code: `const int relayPin = 7;

void setup() {
  pinMode(relayPin, OUTPUT);
  digitalWrite(relayPin, HIGH); // ‡∏õ‡∏¥‡∏î Relay ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Active LOW)
}

void loop() {
  digitalWrite(relayPin, LOW);  // ‡πÄ‡∏õ‡∏¥‡∏î Relay (Active)
  delay(2000);
  digitalWrite(relayPin, HIGH); // ‡∏õ‡∏¥‡∏î Relay
  delay(2000);
}`
  },
  {
    keywords: ['soil', 'moisture', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô', '‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ'],
    topic: 'Soil Moisture Sensor',
    response: "‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÅ‡∏ö‡∏ö Analog ‡∏¢‡∏¥‡πà‡∏á‡∏î‡∏¥‡∏ô‡πÅ‡∏´‡πâ‡∏á ‡∏Ñ‡πà‡∏≤‡∏à‡∏∞‡∏¢‡∏¥‡πà‡∏á‡∏™‡∏π‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ö‡∏ö Resistive ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)",
    code: `const int soilPin = A0;

void setup() {
  Serial.begin(9600);
}

void loop() {
  int moistureValue = analogRead(soilPin);
  
  Serial.print("Soil Moisture: ");
  Serial.println(moistureValue);
  
  if(moistureValue > 800) {
    Serial.println("Soil is DRY -> Turn on pump");
  } else {
    Serial.println("Soil is WET");
  }
  
  delay(1000);
}`
  },
  {
    keywords: ['button', 'pushbutton', 'switch', '‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î'],
    topic: 'Push Button',
    response: "‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ INPUT_PULLUP ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏ï‡πâ‡∏≤‡∏ô‡∏ó‡∏≤‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö (‡∏Å‡∏î‡∏ï‡∏¥‡∏î = LOW, ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏î‡∏±‡∏ö = HIGH)",
    code: `const int buttonPin = 2;
const int ledPin = 13;

void setup() {
  pinMode(buttonPin, INPUT_PULLUP); // ‡πÉ‡∏ä‡πâ Pull-up ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô
  pinMode(ledPin, OUTPUT);
}

void loop() {
  int buttonState = digitalRead(buttonPin);

  if (buttonState == LOW) { // ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° (LOW)
    digitalWrite(ledPin, HIGH);
  } else {
    digitalWrite(ledPin, LOW);
  }
}`
  },
  {
    keywords: ['lcd', 'i2c', 'display', '‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠', '‡∏à‡∏≠'],
    topic: 'LCD I2C (16x2)',
    response: "‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡∏≠ LCD ‡πÅ‡∏ö‡∏ö I2C ‡∏ä‡πà‡∏ß‡∏¢‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏≤‡∏¢‡πÑ‡∏ü ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ LiquidCrystal_I2C ‡πÅ‡∏•‡∏∞‡∏´‡∏≤ Address (‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ñ‡∏∑‡∏≠ 0x27 ‡∏´‡∏£‡∏∑‡∏≠ 0x3F)",
    code: `#include <Wire.h> 
#include <LiquidCrystal_I2C.h>

// ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Address 0x27 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏≠ 16 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
LiquidCrystal_I2C lcd(0x27, 16, 2);

void setup() {
  lcd.init();
  lcd.backlight(); // ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
  
  lcd.setCursor(0, 0); // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 0 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 0
  lcd.print("Hello, Arduino!");
  
  lcd.setCursor(0, 1); // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 0 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 1
  lcd.print("I2C LCD Display");
}

void loop() {
  // ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ
}`
  }
];

// --- Components ---

const MessageBubble = ({ message }) => {
  const isBot = message.sender === 'bot';
  const [copied, setCopied] = useState(false);

  const handleCopy = () => {
    navigator.clipboard.writeText(message.code);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  return (
    <div className={`flex w-full mb-6 ${isBot ? 'justify-start' : 'justify-end'}`}>
      <div className={`flex max-w-[90%] md:max-w-[80%] ${isBot ? 'flex-row' : 'flex-row-reverse'}`}>
        {/* Avatar */}
        <div className={`flex-shrink-0 h-10 w-10 rounded-full flex items-center justify-center mr-2 ml-2 ${isBot ? 'bg-teal-600' : 'bg-blue-600'}`}>
          {isBot ? <Bot size={24} className="text-white" /> : <User size={24} className="text-white" />}
        </div>

        {/* Content */}
        <div className={`flex flex-col ${isBot ? 'items-start' : 'items-end'}`}>
          <div className={`p-4 rounded-2xl shadow-sm text-sm md:text-base whitespace-pre-wrap ${
            isBot 
              ? 'bg-white text-gray-800 rounded-tl-none border border-gray-100' 
              : 'bg-blue-600 text-white rounded-tr-none'
          }`}>
            {message.text}
          </div>

          {/* Code Block (Only for Bot if code exists) */}
          {isBot && message.code && (
            <div className="mt-3 w-full max-w-2xl rounded-lg overflow-hidden border border-gray-700 shadow-lg bg-[#1e1e1e]">
              <div className="flex items-center justify-between px-4 py-2 bg-[#2d2d2d] border-b border-gray-700">
                <div className="flex items-center space-x-2">
                  <Code size={16} className="text-teal-400" />
                  <span className="text-xs text-gray-300 font-mono">Arduino C++</span>
                </div>
                <button 
                  onClick={handleCopy}
                  className="flex items-center space-x-1 text-xs text-gray-400 hover:text-white transition-colors"
                >
                  {copied ? <Check size={14} className="text-green-400" /> : <Copy size={14} />}
                  <span>{copied ? 'Copied!' : 'Copy'}</span>
                </button>
              </div>
              <div className="p-4 overflow-x-auto">
                <pre className="font-mono text-sm text-gray-300 leading-relaxed">
                  <code>{message.code}</code>
                </pre>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

const QuickActionChip = ({ label, onClick }) => (
  <button 
    onClick={onClick}
    className="px-4 py-2 bg-gray-100 hover:bg-teal-50 text-teal-700 text-sm font-medium rounded-full border border-gray-200 hover:border-teal-200 transition-all whitespace-nowrap"
  >
    {label}
  </button>
);

// --- Main App Component ---

export default function App() {
  const [input, setInput] = useState('');
  const [messages, setMessages] = useState([
    {
      id: 1,
      sender: 'bot',
      text: "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ Arduino ü§ñ\n‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Sensor ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏≠‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö\n\n‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡∏ß‡πà‡∏≤: \"‡∏ß‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á HC-SR04\" ‡∏´‡∏£‡∏∑‡∏≠ \"‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ LDR\""
    }
  ]);
  const messagesEndRef = useRef(null);
  const [isTyping, setIsTyping] = useState(false);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages, isTyping]);

  const findResponse = (query) => {
    const normalizedQuery = query.toLowerCase();
    
    // Search in Knowledge Base
    const match = KNOWLEDGE_BASE.find(item => 
      item.keywords.some(keyword => normalizedQuery.includes(keyword))
    );

    if (match) {
      return {
        text: match.response,
        code: match.code
      };
    }

    return {
      text: "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏±‡πâ‡∏ô üòÖ\n\n‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö: Ultrasonic, DHT11, Servo, Relay, LDR, ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î ‡∏´‡∏£‡∏∑‡∏≠ LCD ‡∏î‡∏π‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö",
      code: null
    };
  };

  const handleSend = async (textOverride = null) => {
    const textToSend = textOverride || input;
    if (!textToSend.trim()) return;

    // Add User Message
    const userMsgId = Date.now();
    setMessages(prev => [...prev, { id: userMsgId, sender: 'user', text: textToSend }]);
    setInput('');
    setIsTyping(true);

    // Simulate Bot Delay
    setTimeout(() => {
      const response = findResponse(textToSend);
      setMessages(prev => [...prev, { 
        id: Date.now() + 1, 
        sender: 'bot', 
        text: response.text,
        code: response.code
      }]);
      setIsTyping(false);
    }, 600 + Math.random() * 500); // Random delay for realism
  };

  const handleKeyDown = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  };

  const quickActions = [
    "‡∏ß‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á HC-SR04",
    "‡∏ß‡∏±‡∏î‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ DHT11",
    "‡∏´‡∏°‡∏∏‡∏ô Servo Motor",
    "‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏¥‡∏î‡πÑ‡∏ü LED",
    "‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô",
    "‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏≠ LCD"
  ];

  return (
    <div className="flex flex-col h-screen bg-gray-50 text-gray-900 font-sans">
      
      {/* Header */}
      <header className="bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between sticky top-0 z-10 shadow-sm">
        <div className="flex items-center space-x-3">
          <div className="bg-teal-600 p-2 rounded-lg">
            <Cpu size={24} className="text-white" />
          </div>
          <div>
            <h1 className="text-xl font-bold text-gray-800">Arduino Code Helper</h1>
            <p className="text-xs text-gray-500 flex items-center">
              <span className="w-2 h-2 bg-green-500 rounded-full mr-1 animate-pulse"></span>
              Online ‚Ä¢ Ready to code
            </p>
          </div>
        </div>
        <button 
          onClick={() => setMessages([{ id: 1, sender: 'bot', text: "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö" }])}
          className="p-2 text-gray-400 hover:text-teal-600 hover:bg-teal-50 rounded-full transition-colors"
          title="Reset Chat"
        >
          <RefreshCw size={20} />
        </button>
      </header>

      {/* Chat Area */}
      <main className="flex-1 overflow-y-auto p-4 md:p-6 bg-[#f8fafc]">
        <div className="max-w-4xl mx-auto">
          {messages.map((msg) => (
            <MessageBubble key={msg.id} message={msg} />
          ))}
          
          {isTyping && (
            <div className="flex justify-start mb-6 animate-pulse">
               <div className="flex items-center space-x-2 ml-14 bg-white px-4 py-3 rounded-2xl rounded-tl-none border border-gray-100 shadow-sm">
                 <div className="w-2 h-2 bg-teal-400 rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></div>
                 <div className="w-2 h-2 bg-teal-400 rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></div>
                 <div className="w-2 h-2 bg-teal-400 rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></div>
               </div>
            </div>
          )}
          <div ref={messagesEndRef} />
        </div>
      </main>

      {/* Input Area */}
      <footer className="bg-white border-t border-gray-200 p-4">
        <div className="max-w-4xl mx-auto">
          
          {/* Quick Actions (Horizontal Scroll) */}
          <div className="flex space-x-2 overflow-x-auto pb-3 mb-2 scrollbar-hide">
             <div className="flex items-center text-xs text-gray-400 font-medium mr-2">
               <Zap size={14} className="mr-1" /> ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:
             </div>
             {quickActions.map((action, idx) => (
               <QuickActionChip key={idx} label={action} onClick={() => handleSend(action)} />
             ))}
          </div>

          {/* Text Input */}
          <div className="relative flex items-center">
            <div className="absolute left-4 text-gray-400">
               <Terminal size={20} />
            </div>
            <input
              type="text"
              value={input}
              onChange={(e) => setInput(e.target.value)}
              onKeyDown={handleKeyDown}
              placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà... (‡πÄ‡∏ä‡πà‡∏ô '‡∏Ç‡∏≠‡πÇ‡∏Ñ‡πâ‡∏î Relay')"
              className="w-full pl-12 pr-14 py-4 bg-gray-100 border-2 border-transparent focus:bg-white focus:border-teal-500 rounded-xl outline-none transition-all shadow-sm text-gray-700 placeholder-gray-400"
            />
            <button
              onClick={() => handleSend()}
              disabled={!input.trim()}
              className={`absolute right-2 p-2 rounded-lg transition-all ${
                input.trim() 
                  ? 'bg-teal-600 text-white hover:bg-teal-700 shadow-md transform hover:scale-105' 
                  : 'bg-gray-200 text-gray-400 cursor-not-allowed'
              }`}
            >
              <Send size={20} />
            </button>
          </div>
          <div className="text-center mt-2">
            <p className="text-xs text-gray-400">
              AI ‡∏≠‡∏≤‡∏à‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Pin wiring ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á
            </p>
          </div>
        </div>
      </footer>

    </div>
  );
}
